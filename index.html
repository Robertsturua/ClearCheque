<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transfer</title>

  <style>
    body { margin:0; background:#f4f6fb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; }
    .wrap { max-width:820px; margin:24px auto; padding:0 14px; }

    .card { background:#fff; border-radius:16px; padding:16px; box-shadow:0 8px 22px rgba(0,0,0,.08); margin-bottom:14px; }
    .header { display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#444; }
    .txid { font-family: ui-monospace, Menlo, Consolas, monospace; font-weight:800; }

    .summary { display:flex; gap:16px; flex-wrap:wrap; }
    .metric { flex:1; min-width:200px; }
    .label { font-size:12px; font-weight:800; color:#555; }
    .value { font-size:26px; font-weight:950; margin-top:4px; }
    .status { display:inline-block; margin-top:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; }

    h1 { font-size:18px; margin:0 0 8px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:700px){ .grid{ grid-template-columns:1fr; } }

    label { font-size:12px; font-weight:800; margin:10px 0 6px; display:block; }
    input, select, textarea, button { width:100%; padding:11px 12px; border-radius:12px; border:1px solid #d7dbe6; font-size:14px; box-sizing:border-box; background:#fff; }
    textarea { min-height:90px; resize:vertical; }

    .actions { display:flex; gap:10px; margin-top:14px; }
    button { border:0; font-weight:900; cursor:pointer; padding:12px; }
    button:active { transform: translateY(1px); }
    .primary { background:#1a73e8; color:#fff; }
    .secondary { background:#e9eef9; color:#1a3d8f; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .error { display:none; margin-top:10px; font-size:12px; font-weight:800; color:#b00020; }
    .footerNote { text-align:center; color:#7a7a7a; font-size:12px; margin-top:8px; }

    /* Bigger banner */
    .caseBanner {
      display:none;
      padding: 16px 16px;
      border: 1px solid #c7f9d4;
      background: #f0fdf4;
      border-radius: 16px;
    }
    .bannerTitle {
      font-weight: 950;
      font-size: 16px;
      color: #0f5132;
      margin-bottom: 4px;
    }
    .bannerText {
      font-size: 13px;
      color: #475569;
      line-height: 1.4;
    }
    .bannerRow {
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap: wrap;
    }

    /* Locked look */
    .lockedDim {
      opacity: .55;
      filter: grayscale(.15);
    }
    .lockWrap {
      position: relative;
    }
    .lockOverlay {
      display:none;
      position:absolute;
      inset:0;
      border-radius:16px;
      background: rgba(244,246,251,.35);
      border: 1px solid rgba(203,213,225,.7);
      pointer-events: none;
    }
    .lockOverlayLabel {
      position:absolute;
      top: 12px;
      right: 12px;
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#7c2d12;
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Banner -->
    <div class="card caseBanner" id="caseBanner">
      <div class="bannerRow">
        <div>
          <div class="bannerTitle">Case submitted</div>
          <div class="bannerText" id="caseBannerText">
            Under review. We will contact you if additional information is required.
          </div>
        </div>
        <button id="dismissBannerBtn" class="secondary" style="width:auto;">Dismiss</button>
      </div>
    </div>

    <div class="card header">
      <div>Transaction</div>
      <div class="txid" id="txId">—</div>
    </div>

    <!-- We wrap summary + form so we can dim/overlay them when locked -->
    <div id="lockArea" class="lockWrap">
      <div id="lockOverlay" class="lockOverlay">
        <div class="lockOverlayLabel">Locked</div>
      </div>

      <div class="card summary" id="summaryCard">
        <div class="metric">
          <div class="label">Balance</div>
          <div class="value"><span id="tcBalance">€45,897.27</span></div>
        </div>
        <div class="metric">
          <div class="label">Status</div>
          <div class="status"><span id="tcStatus">HOLD</span></div>
        </div>
      </div>

      <div class="card" id="formCard">
        <h1>Transfer details</h1>

        <div class="grid">
          <div>
            <label>Destination bank</label>
            <select id="bank">
              <option value="">Select bank</option>
              <option>Barclays</option>
              <option>HSBC</option>
              <option>Lloyds</option>
              <option>NatWest</option>
              <option>Revolut</option>
              <option>Santander</option>
              <option>Halifax</option>
              <option>Starling</option>
              <option>Monzo</option>
              <option>Virgin Money</option>
              <option>Nationwide</option>
              <option>TSB Bank</option>
              <option>Virgin Money</option>
            </select>
          </div>

          <div>
            <label>Recipient name</label>
            <input id="recipient" type="text" />
          </div>

          <div>
            <label>Country</label>
            <select id="country"></select>
          </div>

          <div>
            <label>Reference</label>
            <input id="reference" type="text" />
          </div>

          <div style="grid-column:1 / -1;">
            <label>Note</label>
            <textarea id="note"></textarea>
          </div>
        </div>

        <div id="error" class="error"></div>

        <div class="actions">
          <button class="primary" id="previewBtn" type="button">Preview transfer</button>
          <button class="secondary" id="resetBtn" type="button">Reset</button>
        </div>
      </div>
    </div>

    <div class="footerNote"></div>
  </div>

  <script>
    // Transaction ID
    function randDigits(n){ let s=""; for(let i=0;i<n;i++) s += Math.floor(Math.random()*10); return s; }
    const txId = sessionStorage.getItem("txId") || `TX-${randDigits(8)}`;
    sessionStorage.setItem("txId", txId);
    document.getElementById("txId").textContent = txId;

    // Countries
    const countries = [
      "Australia","Austria","Belgium","Brazil","Canada","China","Denmark",
      "Finland","France","Germany","India","Ireland","Italy","Japan",
      "Netherlands","New Zealand","Norway","Poland","Portugal","Spain",
      "Sweden","Switzerland","United Kingdom","United States"
    ].sort();

    const countryEl = document.getElementById("country");
    countries.forEach(c => {
      const o = document.createElement("option");
      o.textContent = c; o.value = c;
      countryEl.appendChild(o);
    });
    countryEl.value = "United Kingdom";

    // Form elements
    const bankEl = document.getElementById("bank");
    const recipientEl = document.getElementById("recipient");
    const referenceEl = document.getElementById("reference");
    const noteEl = document.getElementById("note");
    const previewBtn = document.getElementById("previewBtn");
    const resetBtn = document.getElementById("resetBtn");
    const errorEl = document.getElementById("error");

    function showError(msg){ errorEl.textContent = msg; errorEl.style.display = "block"; }
    function clearError(){ errorEl.textContent = ""; errorEl.style.display = "none"; }

    function setFormLocked(locked) {
      bankEl.disabled = locked;
      recipientEl.disabled = locked;
      countryEl.disabled = locked;
      referenceEl.disabled = locked;
      noteEl.disabled = locked;
      previewBtn.disabled = locked;
      resetBtn.disabled = locked;

      // Visual lock look
      document.getElementById("summaryCard").classList.toggle("lockedDim", locked);
      document.getElementById("formCard").classList.toggle("lockedDim", locked);
      document.getElementById("lockOverlay").style.display = locked ? "block" : "none";
    }

    // Banner logic + timestamp
    const bannerEl = document.getElementById("caseBanner");
    const bannerTextEl = document.getElementById("caseBannerText");
    const dismissBtn = document.getElementById("dismissBannerBtn");

    function formatSubmissionTime(ms) {
      const d = new Date(ms);
      const now = new Date();
      const isToday =
        d.getDate() === now.getDate() &&
        d.getMonth() === now.getMonth() &&
        d.getFullYear() === now.getFullYear();

      const time = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      const date = d.toLocaleDateString();

      return isToday ? `Submitted today at ${time}` : `Submitted on ${date} at ${time}`;
    }

    const caseStatusRaw = sessionStorage.getItem("caseStatus");
    if (caseStatusRaw) {
      try {
        const cs = JSON.parse(caseStatusRaw);
        if (cs?.state === "UNDER_REVIEW") {
          const timePart = cs.at ? ` • ${formatSubmissionTime(cs.at)}` : "";
          const txPart = cs.txId ? `Under review for ${cs.txId}` : "Under review";

          bannerTextEl.textContent =
            `${txPart}${timePart}. No further changes can be made while the case is under review.`;

          bannerEl.style.display = "block";
          setFormLocked(true);
        }
      } catch (_) {}
    }

    dismissBtn.addEventListener("click", () => {
      sessionStorage.removeItem("caseStatus");
      bannerEl.style.display = "none";
      setFormLocked(false);
    });

    // Actions
    previewBtn.addEventListener("click", () => {
      clearError();
      if (!bankEl.value) return showError("Select destination bank.");
      if (!recipientEl.value.trim()) return showError("Enter recipient name.");
      if (!countryEl.value) return showError("Select country.");

      const draft = {
        txId,
        balanceEur: 5400,
        status: "HOLD",
        transfer: {
          bank: bankEl.value,
          recipient: recipientEl.value.trim(),
          country: countryEl.value,
          reference: referenceEl.value.trim(),
          note: noteEl.value.trim()
        }
      };

      sessionStorage.setItem("transferDraft", JSON.stringify(draft));
      window.location.href = "kyc.html";
    });

    resetBtn.addEventListener("click", () => {
      bankEl.value = "";
      recipientEl.value = "";
      referenceEl.value = "";
      noteEl.value = "";
      countryEl.value = "United Kingdom";
      clearError();
      sessionStorage.removeItem("transferDraft");
    });
  </script>

<script>
  // Trading Centre access gate (client-side, for on-camera prop use)
  (function() {
    const SESSION_USER_KEY = "tc_session_user_v1";
    const ACCOUNTS_KEY = "tc_accounts_v1";

    const DEFAULT_ACCOUNTS = {
      "test":    { pass: "test",   balance: "€45,897.27", currency: "EUR", status: "HOLD" },
      "william": { pass: "A1B2C3", balance: "£50,000.00", currency: "GBP", status: "HOLD" },
      "sonia":   { pass: "A1B2C3", balance: "£60,000.00", currency: "GBP", status: "HOLD" },
      "charles": { pass: "A1B2C3", balance: "£70,000.00", currency: "GBP", status: "HOLD" },
      "jay":     { pass: "A1B2C3", balance: "£80,000.00", currency: "GBP", status: "HOLD" },
    };

    function loadAccounts() {
    try {
      const raw = localStorage.getItem(ACCOUNTS_KEY);
      const parsed = raw ? JSON.parse(raw) : null;
      if (!parsed || typeof parsed !== "object") throw new Error("no accounts");

      // Normalize / migrate: keep any locally changed passwords,
      // but always enforce the canonical per-account balances & status
      // (prevents stale older defaults from "sticking" forever).
      const merged = {};
      for (const [user, def] of Object.entries(DEFAULT_ACCOUNTS)) {
        const existing = parsed[user] && typeof parsed[user] === "object" ? parsed[user] : null;
        merged[user] = {
          pass: existing && typeof existing.pass === "string" ? existing.pass : def.pass,
          balance: def.balance,
          currency: def.currency,
          status: def.status
        };
      }
      // Preserve any extra accounts that might exist locally
      for (const [user, data] of Object.entries(parsed)) {
        if (!merged[user] && data && typeof data === "object") merged[user] = data;
      }

      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(merged));
      return merged;
    } catch (e) {
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(DEFAULT_ACCOUNTS));
      return DEFAULT_ACCOUNTS;
    }
  }

    function ensureUserOrRedirect() {
      const u = sessionStorage.getItem(SESSION_USER_KEY);
      if (!u) {
        const next = encodeURIComponent("index.html");
        window.location.href = "login.html?next=" + next;
        return null;
      }
      return u;
    }

    const user = ensureUserOrRedirect();
    if (!user) return;

    const accounts = loadAccounts();
    const acct = accounts[user] || accounts["test"];

    // Populate common fields if present
    const balEl = document.getElementById("tcBalance");
    if (balEl) balEl.textContent = acct.balance;

    const statusEl = document.getElementById("tcStatus");
    if (statusEl) statusEl.textContent = acct.status;

    const userEl = document.getElementById("tcUser");
    if (userEl) userEl.textContent = user.charAt(0).toUpperCase() + user.slice(1);

  })();  
</script>

</body>
</html>
